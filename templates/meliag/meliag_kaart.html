{% extends "meliag/meliag_base.html" %}

{% block title %}Kaart{% endblock %}
{% set active_page = "kaart" %}

{% block headers %}
<link rel="stylesheet" href="{{ url_for('static', filename='meliag/meliag_kaart.css') }}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
{% endblock %}




{% block content %}
<div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        const map = L.map('map').setView([52.3676, 4.9041], 8);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        const markers = new Map();

        async function fetchTreinen() {
            try {
                const response = await fetch('/meliag/api/pos');
                const data = await response.json();

                if (data.payload && data.payload.treinen) {
                    const seenTrainIds = new Set();

                    data.payload.treinen.forEach(trein => {
                        const { lat, lng, type, ritId, snelheid, richting } = trein;
                        seenTrainIds.add(ritId);

                        if (markers.has(ritId)) {
                            const marker = markers.get(ritId);
                            marker.setLatLng([lat, lng]);

                            marker.getPopup()
                                .setContent(`
                                    <b>Ritnummer:</b> ${ritId}<br>
                                    <b>Snelheid:</b> ${snelheid.toFixed(1)} km/h<br>
                                `);
                        } else {
                            // Marker bestaat nog niet; voeg een nieuwe toe
                            const marker = L.marker([lat, lng])
                                .addTo(map)
                                .bindPopup(`
                                    <b>Ritnummer:</b> ${ritId}<br>
                                    <b>Snelheid:</b> ${snelheid.toFixed(1)} km/h<br>
                                `);
                            markers.set(ritId, marker);
                        }
                    });

                    markers.forEach((marker, ritId) => {
                        if (!seenTrainIds.has(ritId)) {
                            map.removeLayer(marker);
                            markers.delete(ritId);
                        }
                    });
                } else {
                    console.error("Geen treinlocaties beschikbaar");
                }
            } catch (error) {
                console.error("Fout bij ophalen van treinlocaties:", error);
            }
        }

        fetchTreinen();

        setInterval(fetchTreinen, 30000);
    </script>
{% endblock %}
