{% extends "meliag/meliag_base.html" %}

{% block title %}Kaart{% endblock %}
{% set active_page = "kaart" %}

{% block headers %}
<link rel="stylesheet" href="{{ url_for('static', filename='meliag/meliag_kaart.css') }}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
{% endblock %}




{% block content %}
<div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        const map = L.map('map').setView([52.3676, 4.9041], 8);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        const markers = new Map();

        async function fetchTreinen() {
            try {
                const response = await fetch('/meliag/api/pos');
                const data = await response.json();

                if (data) {
                    const seenTrainIds = new Set();

                    data.forEach(trein => {
                        const { ritNum, lat, lon, snelheid, treinSoort, materieel, station, spoor, materieelNums, afbeeldingen } = trein;
                        seenTrainIds.add(ritNum);

                        if (markers.has(ritNum)) {
                            const marker = markers.get(ritNum);
                            marker.setLatLng([lat, lon]);

                            marker.getPopup()
                                .setContent(`
                                    <b>Ritnummer:</b> ${ritNum}<br>
                                    <b>Snelheid:</b> ${snelheid.toFixed(1)} km/h<br>
                                    <b>Treinsoort:</b> ${treinSoort}<br>
                                    <b>Materieel:</b> ${materieel}<br>
                                    <b>Station:</b> ${station}<br>
                                    <b>Spoor:</b> ${spoor}<br>
                                    <b>Materieelnummers:</b> ${materieelNums.join(', ')}
                                `);
                        } else {
                            const marker = L.marker([lat, lon])
                                .addTo(map)
                                .bindPopup(`
                                    <b>Ritnummer:</b> ${ritNum}<br>
                                    <b>Snelheid:</b> ${snelheid.toFixed(1)} km/h<br>
                                    <b>Treinsoort:</b> ${treinSoort}<br>
                                    <b>Materieel:</b> ${materieel}<br>
                                    <b>Station:</b> ${station}<br>
                                    <b>Spoor:</b> ${spoor}<br>
                                    <b>Materieelnummers:</b> ${materieelNums.join(', ')}
                                `);
                            markers.set(ritNum, marker);
                        }
                    });

                    markers.forEach((marker, ritNum) => {
                        if (!seenTrainIds.has(ritNum)) {
                            map.removeLayer(marker);
                            markers.delete(ritNum);
                        }
                    });
                } else {
                    console.error("Geen treinlocaties beschikbaar");
                }
            } catch (error) {
                console.error("Fout bij ophalen van treinlocaties:", error);
            }
        }

        fetchTreinen();

        setInterval(fetchTreinen, 30000);
    </script>
{% endblock %}